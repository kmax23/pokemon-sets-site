---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { fetchSets, fetchSet, fetchCardsBySet } from '../../lib/pokemontcg.js';

export async function getStaticPaths() {
  let sets = [];
  try {
    sets = await fetchSets();
  } catch (err) {
    console.error("Failed to fetch sets in getStaticPaths:", err);
  }

  if (!sets || !Array.isArray(sets)) {
    console.warn("No sets returned from API, falling back to empty list.");
    return [];
  }

  // Limit to first 50 sets for performance
  const limited = sets.slice(0, 50);

  return limited.map((set) => ({
    params: { slug: set.id },
    props: { set },
  }));
}

const { slug } = Astro.params;

let set = null;
let cards = [];

try {
  set = await fetchSet(slug);
} catch (err) {
  console.error(`Failed to fetch set for slug: ${slug}`, err);
}

try {
  cards = await fetchCardsBySet(slug);
} catch (err) {
  console.error(`Failed to fetch cards for set: ${slug}`, err);
}
---

<BaseLayout title={set ? set.name : "Set not available"}>
  <div class="max-w-6xl mx-auto p-6">
    {set ? (
      <>
        <h1 class="text-4xl font-bold mb-4">{set.name}</h1>
        <p class="text-gray-500 mb-2">{set.series}</p>
        <p class="text-gray-500 mb-2">Total Cards: {set.total}</p>
        <p class="text-gray-500 mb-4">Release Date: {set.releaseDate}</p>
      </>
    ) : (
      <p class="text-red-500 font-semibold mb-4">
        This set could not be loaded. Please try again later.
      </p>
    )}

    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
      {cards.length > 0 ? (
        cards.map(card => (
          <a href={`/cards/${card.id}`} class="bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition-shadow duration-200 overflow-hidden">
            <img src={card.images.small} alt={card.name} class="w-full h-48 object-cover" />
            <div class="p-2">
              <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 truncate">{card.name}</h2>
              <p class="text-gray-500 dark:text-gray-400 text-sm">{card.rarity || 'Unknown'}</p>
            </div>
          </a>
        ))
      ) : (
        <p class="col-span-full text-center text-gray-500">
          No cards available for this set.
        </p>
      )}
    </div>

    <div class="mt-6">
      <a href="/sets" class="text-blue-500 hover:underline">&larr; Back to all sets</a>
    </div>
  </div>
</BaseLayout>
